SET TERM ^ ;

CREATE OR ALTER PROCEDURE GERAR_REQUISICAO (
    CODCLIENTE VARCHAR(8),
    PEDIDO VARCHAR(18),
    NPEDIDOGMSAP VARCHAR(8),
    PECA VARCHAR(30),
    QTD INTEGER NOT NULL,
    OBS blob sub_type 1 segment size 80 character set WIN1252
) AS
DECLARE VARIABLE CD_REQ INTEGER;
DECLARE VARIABLE DATA_HOJE DATE;
DECLARE VARIABLE HORA_HOJE TIME;
DECLARE VARIABLE DATAATUAL TIMESTAMP;
DECLARE VARIABLE ID_CLIENTE_REQ INTEGER;
DECLARE VARIABLE ID_PRODUTO INTEGER;
DECLARE VARIABLE DESCRICAO VARCHAR(190);
DECLARE VARIABLE ID_ITEM INTEGER;
DECLARE VARIABLE VALOR_UNITARIO CURRENCY;
DECLARE VARIABLE VALOR_REQ CURRENCY;
DECLARE VARIABLE REF VARCHAR(15);
DECLARE VARIABLE CODIGO_FAB VARCHAR(20);
DECLARE VARIABLE MARCA VARCHAR(50);
DECLARE VARIABLE CODIGO_BARRA VARCHAR(40);

BEGIN
    DATAATUAL = CURRENT_TIMESTAMP;
    DATA_HOJE = CURRENT_DATE;
    HORA_HOJE = CURRENT_TIME;

    SELECT MAX(ID_ITEM) FROM REQUISICOES_ITENS INTO :ID_ITEM;
    ID_ITEM = COALESCE(ID_ITEM, 0) + 1;

    SELECT ID_PRODUTO FROM produtos p WHERE p.codigo_fab = :PECA ORDER BY p.descricao ASC ROWS 1 INTO :ID_PRODUTO;
    SELECT DESCRICAO FROM produtos p WHERE p.codigo_fab = :PECA ORDER BY p.descricao ASC ROWS 1 INTO :DESCRICAO;
    SELECT PRECO_TABELA FROM PRODUTO_PRECOS p WHERE p.ID_PRODUTO = :ID_PRODUTO INTO :VALOR_UNITARIO;
    SELECT REF FROM produtos p WHERE p.codigo_fab = :PECA ORDER BY p.descricao ASC ROWS 1 INTO :REF;
    SELECT CODIGO_FAB FROM produtos p WHERE p.codigo_fab = :PECA ORDER BY p.descricao ASC ROWS 1 INTO :CODIGO_FAB;
    SELECT MARCA FROM produtos p WHERE p.codigo_fab = :PECA ORDER BY p.descricao ASC ROWS 1 INTO :MARCA;
    SELECT CODIGO_BARRA FROM produtos p WHERE p.codigo_fab = :PECA ORDER BY p.descricao ASC ROWS 1 INTO :CODIGO_BARRA;
    SELECT ID_CLIENTE FROM CLIENTES c WHERE c.DOC_EX = :CODCLIENTE ORDER BY c.NOME ASC ROWS 1 INTO :ID_CLIENTE_REQ;
    SELECT MAX(ID_REQUISICAO) FROM REQUISICOES INTO :CD_REQ;
    CD_REQ = COALESCE(CD_REQ, 0) + 1;
    VALOR_REQ = :VALOR_UNITARIO*QTD;

    INSERT INTO REQUISICOES (
        ID_REQUISICAO,
        ES,
        ID_CLIENTE,
        DATA_EMISSAO,
        HORA_EMISSAO,
        NUMERO,
        ID_FUNCIONARIO,
        PEDIDO,
        OBS,
        VALOR_REQUISICAO,
        ID_VEICULO,
        ID_DEPTO,
        COTACAO,
        STATUS,
        VEICULO,
        PLACA,
        ITENS,
        ENTREGUE
    ) VALUES (
        :CD_REQ,
        1,
        :ID_CLIENTE_REQ,
        :DATA_HOJE,
        :HORA_HOJE,
        NULL,
        1,
        :PEDIDO,
        :OBS,
        :VALOR_REQ,
        NULL,
        1,
        0,
        1,
        NULL,
        :NPEDIDOGMSAP,
        1,
        0
    );

    INSERT INTO REQUISICOES_ITENS (
        ID_REQUISICAO, 
        ID_ITEM, 
        ID_PRODUTO, 
        DESCRICAO, 
        QTDE, 
        VALOR_UNITARIO, 
        REF, 
        DADOS, 
        CODIGO_FAB, 
        MARCA, 
        CODIGO_BARRA, 
        ENTREGAR, 
        ENTREGUE, 
        DATA_ENTREGA
    ) 
    VALUES (
        :CD_REQ, 
        :ID_ITEM, 
        :ID_PRODUTO, 
        :DESCRICAO, 
        :QTD, 
        :VALOR_UNITARIO, 
        :REF, 
        NULL, 
        :CODIGO_FAB, 
        :MARCA, 
        :CODIGO_BARRA, 
        :QTD, 
        0, 
        NULL
    );

END^

SET TERM ; ^
